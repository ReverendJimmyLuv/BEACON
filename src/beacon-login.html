<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<!--<link rel="import" href="../src/login-fire-changed-paths/login-fire.html">-->
<link rel="import" href="../bower_components/login-fire/login-fire.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">

<dom-module id="beacon-login">
    <template>
        <style>
            :host {
                display: block;
                background-color: #F29737;
                padding: 10px;
                min-height: 100%;
            }
        </style>

        <firebase-auth id="auth" user="{{user}}" on-user-changed="_userChanged"></firebase-auth>

        <div style="position: absolute; left: 50%">
            <a href="[[rootPath]]home">
                <img src="../images/manifest/horizontal_logo.png" height="57" width="86">
            </a>
        </div>

        <paper-dialog opened$="[[!user]]"
                      style="background-color: #F8C945">
            <h2>You must login to</h2>
            <h2>create a Beeqin</h2>
        </paper-dialog>

        <div class="card">
            <login-fire
                    providers="google,anonymous"
                    user="{{user}}"
                    signed-in="{{SignedIn}}"
                    debug>
            </login-fire>
        </div>

        <template is="dom-if" if="[[user]]">
            <h1>Welcome [[user.displayName]]!</h1>
            <img src="[[user.photoURL]]" height="144" width="144">
        </template>

    </template>

    <script>
        class BeaconLogin extends Polymer.Element {
            static get is() {
                return 'beacon-login';
            }

            static get properties() {
                return {
                    user: {
                        type: Object,
                        notify: true,
                    },
                    statusKnown: {
                        type: Object,
                    },
                };
            }

            _userChanged() {
                firebase.auth().onAuthStateChanged(function (user) {
                    if (user) {
                        var loginQueueRef = firebase.database().ref('/users/userWriteable/loginQueue');
                        var userLoginRef = loginQueueRef.child(user.uid);
                        console.log(userLoginRef.toString(), user);
                        userLoginRef.set({
                            name: user.displayName,
                            email: user.email,
                            uid: user.uid,
                            emailVerified: user.emailVerified,
                            photoUrl: user.photoURL
                        })
                            .catch(function (e) {
                                console.log('login error', e);
                            });
                    }
                });

                var ref = firebase.database().ref('/users');
                var loginsRef = ref.child('userWriteable/loginQueue');
                var accountsRef = ref.child('userReadable/accounts');
                var adminEmails = ['jameshmadsen@gmail.com'];

                loginsRef.on('child_added', function (snap) {
                    console.log('Login queue received', snap.val());
                    var user = snap.val();
                    var userRef = snap.ref;

                    if (~adminEmails.indexOf(user.email)) {
                        user.isAdmin = true;
                    }
                    user.lastLogin = Date.now();

                    accountsRef.child(user.uid).update(user)
                        .then(function () {
                            return userRef.remove();
                        });
                });
            }
        }

        window.customElements.define(BeaconLogin.is, BeaconLogin);
    </script>
</dom-module>


