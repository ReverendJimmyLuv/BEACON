<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/vaadin-button/vaadin-button.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../bower_components/vaadin-radio-button/vaadin-radio-group.html">
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<dom-module id="befound-professional-profile">
    <template>
        <style></style>
        <custom-style>
            <style is="custom-style">
                paper-button.beeqin {
                    position: absolute;
                    bottom: 0;
                    right: 0;
                    background-color: #000000;
                    color: #F8C945;
                }
                paper-button.beeqin[active] {
                    background-color: #F29737;
                    color: #000000;
                }
            </style>
        </custom-style>

        <firebase-storage-multiupload
                id="firebaseStorage"
                path="/users/[[user.uid]]/images"
                files="{{vaadinUpload}}"
                upload-tasks="{{uploadTasks}}"
                on-error="catchError"
                force-unique>
        </firebase-storage-multiupload>

        <!--Main Professional Profile Fields-->
        <br>
        <strong>These fields are here as suggestions for your Professional Profile. Any fields left
            blank will be omitted on your displayed Beeqin. Only share what you want!</strong>
        <hr>
        <h3>Add a Profile Image</h3>

        <vaadin-upload id="vaadinUpload"
                       style="width:100%"
                       files="{{vaadinUpload}}"
                       form-data-name="profile-img"
                       max-files="1"
                       max-file-size="4000000"
                       accept="image/*"
                       on-max-files-reached-changed="_previewUpload">
            <br>
            <iron-image id="imgPreview"
                        style="width:200px; height:200px; background-color: lightgray;"
                        sizing="cover"
                        preload fade
                        src=""
                        alt="Upload Preview">
            </iron-image>
        </vaadin-upload>
        <br>

        <vaadin-button on-tap="_upload">
            <iron-icon icon="lumo:upload" slot="suffix"></iron-icon>
            Upload
        </vaadin-button>
        <br>

        <template is="dom-repeat" items="[[uploadTasks]]">
            <firebase-storage-upload-task
                    id="firebaseUploadTask"
                    task="[[item]]"
                    bytes-transferred="{{item.bytesTransferred}}"
                    total-bytes="{{item.totalBytes}}"
                    state="{{item.state}}"
                    download-url="{{item.downloadUrl}}"
                    metadata="{{item.metadata}}"
                    path="{{item.path}}">
            </firebase-storage-upload-task>

            <template is="dom-if" if="[[!isEqual(item.state, 'success')]]">
                <vaadin-progress-bar
                        value="{{item.bytesTransferred}}"
                        min="0"
                        max="{{item.totalBytes}}">
                </vaadin-progress-bar>
            </template>

            <template is="dom-if" if="{{isEqual(item.state, 'success')}}">
                <firebase-storage-ref
                        path="{{item.path}}"
                        storage-uri="{{gsUri}}"
                        id="ref-[[index]]"
                        metadata="{{item.refMetadata}}"
                        download-url="{{item.refDownloadUrl}}">
                </firebase-storage-ref>

                <!--<iron-image style="width:200px; height:200px; background-color: lightgray;"
                            sizing="cover"
                            preload fade
                            src="{{item.refDownloadUrl}}"
                            alt="{{item.metadata.name}}">
                </iron-image>-->
                <br>
                <vaadin-button on-tap="deleteFile" value="{{index}}">Remove</vaadin-button>
                <br>
            </template>
        </template>


        <vaadin-text-field style="width: 100%" label="Beeqin Display Name"
                           id="displayName"></vaadin-text-field>
        <vaadin-text-field style="width: 100%" label="First Name" id="firstName"></vaadin-text-field>
        <vaadin-text-field style="width: 100%" label="Last Name" id="lastName"></vaadin-text-field>
        <vaadin-text-field style="width: 100%" label="Phone Number"
                           id="phoneNumber"></vaadin-text-field>
        <vaadin-text-field style="width: 100%" label="Email Address"
                           id="emailAddress"></vaadin-text-field>
        <vaadin-radio-group id="messagePermission" value="{{messagePermission}}">
            <p>Would you like people to be able to message you in app for this Beeqin?</p>
            <vaadin-radio-button value="Yes">Yes</vaadin-radio-button>
            <vaadin-radio-button value="No">No</vaadin-radio-button>
        </vaadin-radio-group>
        <vaadin-text-area style="width: 100%; min-height: 100px" label="Headline"
                          id="headline"></vaadin-text-area>
        <vaadin-text-field style="width: 100%" label="College Attended"
                           id="collegeAttended"></vaadin-text-field>
        <vaadin-text-field style="width: 100%" label="High School Attended"
                           id="highSchoolAttended"></vaadin-text-field>
        <vaadin-text-area style="width: 100%; min-height: 100px"
                          label="Organizations You're a Member of"
                          id="organizations"></vaadin-text-area>
        <vaadin-text-field style="width: 100%" label="Industry" id="industry"></vaadin-text-field>
        <vaadin-text-area style="width: 100%; min-height: 200px" label="Summary"
                          id="summary"></vaadin-text-area>

        <vaadin-radio-group id="geoLocOrFixed" value="{{geoLocOrFixed}}">
            <p>Would you like to use your Geo Location for this Beeqin? Or a fixed address?</p>
            <vaadin-radio-button value="Geo Location">Geo Location</vaadin-radio-button>
            <vaadin-radio-button value="Fixed Address">Fixed Address</vaadin-radio-button>
        </vaadin-radio-group>

        <template is="dom-if" if="[[isEqual(geoLocOrFixed, 'Fixed Address')]]">
            <strong>What address?</strong>
            <vaadin-text-field style="width: 100%" label="Street"
                               id="addressStreet"></vaadin-text-field>
            <vaadin-text-field style="width: 100%" label="City" id="addressCity"></vaadin-text-field>
            <vaadin-text-field style="width: 100%" label="State" id="addressState"></vaadin-text-field>
            <vaadin-text-field style="width: 100%" label="Zip Code"
                               id="addressZipCode"></vaadin-text-field>
            <hr>
        </template>

        <vaadin-text-field style="width: 100%" label="Website or Social Media links"
                           id="links1"></vaadin-text-field>
        <vaadin-text-field style="width: 100%" label="" id="links2"></vaadin-text-field>
        <vaadin-text-field style="width: 100%" label="" id="links3"></vaadin-text-field>
        <vaadin-radio-group id="linkBeeqins" value="{{linkBeeqins}}">
            <p>Would you like to link any of your other saved Beeqins to this one?</p>
            <vaadin-radio-button value="Yes">Yes</vaadin-radio-button>
            <vaadin-radio-button value="No">No</vaadin-radio-button>
        </vaadin-radio-group>
        <br>
        <vaadin-combo-box
                style="width: 17em; padding-right: 10px"
                id="foundDistance"
                label="How Far to Broadcast?"
                items="[[distancelist]]"
                value="{{foundDistance}}">
        </vaadin-combo-box>
        <vaadin-combo-box
                style="width: 17em; padding-bottom: 150px"
                id="foundTime"
                label="When do you want to broadcast?"
                items="[[timelist]]"
                value="{{foundTime}}">
        </vaadin-combo-box>

        <br>
        <div style="position: relative">
            <paper-button raised class="custom beeqin" on-tap="_createBeacon">
                <iron-icon icon="beacon-icons:search"></iron-icon>
                !Create Beeqin
            </paper-button>
        </div>


    </template>

    <script>
        class BeFoundProfessionalProfile extends Polymer.Element {
            static get is() {
                return 'befound-professional-profile';
            }

            static get properties() {
                return {
                    uploadTasks: {
                        type: Array,
                        observer: '_uploadTasksChanged'
                    },
                    uploadedFiles: {
                        type: Array,
                    },
                    vaadinUpload: {
                        type: Array,
                        notify: true,
                        value: [],
                    },
                    user: {
                        type: Object,
                        notify: true,
                    },
                    firebaseStorage: {
                        type: Array,
                        notify: true,
                    },
                };
            }

            isEqual(a, b) {
                return a === b;
            }

            _uploadTasksChanged(uploadTasks) {
                console.log("Upload Tasks Array", uploadTasks);
                console.log("Vaadin Upload Array", this.$.vaadinUpload.files);
            }

            _uploadedFilesChanged(uploadedFiles) {
                console.log("Uploaded Files", uploadedFiles);
            }

            deleteFile(e) {
                this.shadowRoot.querySelector('#ref-' + e.target.value).delete().then(function (d) {
                    console.log(d)
                })
            }

            //Show image preview before uploading
            _previewUpload() {
                let preview = this.shadowRoot.querySelector('#imgPreview');
                let file = this.$.vaadinUpload.files[0];
                let reader = new FileReader();

                /*file.addEventListener("file-remove", function() {
                    preview.src = "";
            });*/
                reader.addEventListener("load", function () {
                    preview.src = reader.result;
                }, false);

                if (file) {
                    reader.readAsDataURL(file);
                }
            }


            //Upload image to Firebase
            _upload() {
                this.$.firebaseStorage.upload(this.$.vaadinUpload.files);
            }

            //create beeqin and push to firebase.  need to adjust to a preview view first
            _createBeacon() {
                this.$.befound.ref.push({
                    user: this.user.uid,
                    coreType: this.$.coreType.value,
                    found2: this.$.found2.value,
                    found3: this.$.found3.value,
                    beFoundDescription: this.$.beFoundDescription.value,
                    foundDistance: this.$.foundDistance.value,
                    foundTime: this.$.foundTime.value,
                    latitude: this.$.latitude.value,
                    longitude: this.$.longitude.value
                });
                this.$.coreType.value = null;
                this.$.found2.value = null;
                this.$.found3.value = null;
                this.$.beFoundDescription.value = null;
                this.$.foundDistance.value = null;
                this.$.foundTime.value = null;
                this.beaconCreated = true;
            }

        }

        window.customElements.define(BeFoundProfessionalProfile.is, BeFoundProfessionalProfile);
    </script>
</dom-module>